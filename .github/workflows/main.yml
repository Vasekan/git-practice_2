name: Simple CI with Auto-Docs

on:
  push:
    branches: [ main, development, release ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  test-and-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}          # –≤–∞–∂–Ω–æ: —á—Ç–æ–±—ã –Ω–µ –±—ã—Ç—å –≤ detached HEAD
          fetch-depth: 0                  # —á—Ç–æ–±—ã –ø—É—à/–∏—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç–∞–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if any)
        shell: bash
        run: |
          if [ -f "requirements.txt" ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          fi

      - name: Run tests
        shell: bash
        run: |
          python - <<'PY'
          from math_operations import add_numbers

          result1 = add_numbers(2, 3)
          print(f"2 + 3 = {result1}")
          assert result1 == 5, "–û—à–∏–±–∫–∞: 2+3 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 5"

          result2 = add_numbers(10, 5)
          print(f"10 + 5 = {result2}")
          assert result2 == 15, "–û—à–∏–±–∫–∞: 10+5 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 15"

          print("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!")
          PY

      - name: Generate auto-docs
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          python - <<'PY'
          import ast
          import os
          from datetime import datetime

          SOURCE_FILE = "math_operations.py"
          OUT_FILE = "AUTO_DOCS_TEMP.md"

          def first_sentence(text: str) -> str:
              if not text:
                  return "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"
              text = text.strip()
              if "." in text:
                  return text.split(".", 1)[0].strip()
              return text

          def get_docstring(node) -> str:
              return ast.get_docstring(node) or "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"

          try:
              if not os.path.exists(SOURCE_FILE):
                  raise FileNotFoundError(f"–ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª: {SOURCE_FILE}")

              with open(SOURCE_FILE, "r", encoding="utf-8") as f:
                  code = f.read()

              tree = ast.parse(code)

              functions = []
              classes = []

              # –ë–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è: —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –ø–µ—Ä–µ–ø—É—Ç–∞—é—Ç—Å—è —Å –º–µ—Ç–æ–¥–∞–º–∏
              for node in tree.body:
                  if isinstance(node, ast.FunctionDef):
                      functions.append({
                          "name": node.name,
                          "args": [a.arg for a in node.args.args],
                          "doc": get_docstring(node),
                          "line": node.lineno,
                      })
                  elif isinstance(node, ast.ClassDef):
                      methods = []
                      for item in node.body:
                          if isinstance(item, ast.FunctionDef):
                              methods.append({
                                  "name": item.name,
                                  "doc": get_docstring(item),
                              })
                      classes.append({
                          "name": node.name,
                          "doc": get_docstring(node),
                          "methods": methods,
                      })

              md = f"""<!-- AUTO-GENERATED DOCS START -->
          ## ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

          **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}  
          **–ö–æ–º–º–∏—Ç:** `{os.environ.get('GITHUB_SHA', 'unknown')[:8]}`  
          **–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
          """

              if classes:
                  md += "\n### üèó –ö–ª–∞—Å—Å—ã\n\n"
                  for cls in classes:
                      md += f"#### {cls['name']}\n"
                      md += f"{cls['doc']}\n\n"
                      if cls["methods"]:
                          md += "**–ú–µ—Ç–æ–¥—ã:**\n"
                          for m in cls["methods"]:
                              md += f"- `{m['name']}()` - {first_sentence(m['doc'])}\n"
                      md += "\n"

              if functions:
                  md += "### üîß –§—É–Ω–∫—Ü–∏–∏\n\n"
                  for fn in functions:
                      args = ", ".join(fn["args"])
                      md += f"- **`{fn['name']}({args})`**  \n"
                      md += f"  {first_sentence(fn['doc'])}  \n"
                      md += f"  *—Å—Ç—Ä–æ–∫–∞ {fn['line']}*\n\n"

              md += "---\n"
              md += "*–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ –≤ main*\n"
              md += "<!-- AUTO-GENERATED DOCS END -->\n"

              with open(OUT_FILE, "w", encoding="utf-8") as f:
                  f.write(md)

              print("‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞")

          except Exception as e:
              print(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: {e}")
              raise
          PY

      - name: Update README.md
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          python - <<'PY'
          import os

          DOCS_FILE = "AUTO_DOCS_TEMP.md"
          README_FILE = "README.md"
          START = "<!-- AUTO-GENERATED DOCS START -->"
          END = "<!-- AUTO-GENERATED DOCS END -->"

          if not os.path.exists(DOCS_FILE):
              print("‚ö†Ô∏è –§–∞–π–ª —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ README.")
              raise SystemExit(0)

          with open(DOCS_FILE, "r", encoding="utf-8") as f:
              docs = f.read().rstrip() + "\n"

          if os.path.exists(README_FILE):
              with open(README_FILE, "r", encoding="utf-8") as f:
                  readme = f.read()
          else:
              readme = "# –ú–æ–π –ø—Ä–æ–µ–∫—Ç\n\n"

          if START in readme and END in readme and readme.index(START) < readme.index(END):
              prefix = readme.split(START, 1)[0].rstrip() + "\n\n"
              suffix = readme.split(END, 1)[1].lstrip("\n")
              new_readme = prefix + docs + ("\n" + suffix if suffix else "")
          else:
              new_readme = readme.rstrip() + "\n\n" + docs

          with open(README_FILE, "w", encoding="utf-8") as f:
              f.write(new_readme.rstrip() + "\n")

          os.remove(DOCS_FILE)
          print("‚úÖ README.md –æ–±–Ω–æ–≤–ª—ë–Ω")
          PY

      - name: Commit changes
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md

          if git diff --cached --quiet; then
            echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            exit 0
          fi

          git commit -m "docs: auto-update [skip ci]"
          git push origin HEAD:${GITHUB_REF_NAME}
