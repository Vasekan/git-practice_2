name: Simple CI with Auto-Docs

on:
  push:
    branches: [ main, development, release ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  test-and-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}          
          fetch-depth: 0                  
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if any)
        shell: bash
        run: |
          if [ -f "requirements.txt" ]; then
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          fi

      - name: Run tests
        shell: bash
        run: |
          python - <<'PY'
          from math_operations import add_numbers

          result1 = add_numbers(2, 3)
          print(f"2 + 3 = {result1}")
          assert result1 == 5, "Ошибка: 2+3 должно быть 5"

          result2 = add_numbers(10, 5)
          print(f"10 + 5 = {result2}")
          assert result2 == 15, "Ошибка: 10+5 должно быть 15"

          print("Все тесты пройдены!")
          PY

      - name: Generate auto-docs
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          python - <<'PY'
          import ast
          import os
          from datetime import datetime

          SOURCE_FILE = "math_operations.py"
          OUT_FILE = "AUTO_DOCS_TEMP.md"

          def first_sentence(text: str) -> str:
              if not text:
                  return "Нет описания"
              text = text.strip()
              if "." in text:
                  return text.split(".", 1)[0].strip()
              return text

          def get_docstring(node) -> str:
              return ast.get_docstring(node) or "Нет описания"

          try:
              if not os.path.exists(SOURCE_FILE):
                  raise FileNotFoundError(f"Не найден файл: {SOURCE_FILE}")

              with open(SOURCE_FILE, "r", encoding="utf-8") as f:
                  code = f.read()

              tree = ast.parse(code)

              functions = []
              classes = []

              # Берём только элементы верхнего уровня: функции не перепутаются с методами
              for node in tree.body:
                  if isinstance(node, ast.FunctionDef):
                      functions.append({
                          "name": node.name,
                          "args": [a.arg for a in node.args.args],
                          "doc": get_docstring(node),
                          "line": node.lineno,
                      })
                  elif isinstance(node, ast.ClassDef):
                      methods = []
                      for item in node.body:
                          if isinstance(item, ast.FunctionDef):
                              methods.append({
                                  "name": item.name,
                                  "doc": get_docstring(item),
                              })
                      classes.append({
                          "name": node.name,
                          "doc": get_docstring(node),
                          "methods": methods,
                      })

              md = f"""<!-- AUTO-GENERATED DOCS START -->
          ## Автоматическая документация

          **Обновлено:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}  
          **Коммит:** `{os.environ.get('GITHUB_SHA', 'unknown')[:8]}`  
          **Статус:** Все тесты пройдены
          """

              if classes:
                  md += "\n### Классы\n\n"
                  for cls in classes:
                      md += f"#### {cls['name']}\n"
                      md += f"{cls['doc']}\n\n"
                      if cls["methods"]:
                          md += "**Методы:**\n"
                          for m in cls["methods"]:
                              md += f"- `{m['name']}()` - {first_sentence(m['doc'])}\n"
                      md += "\n"

              if functions:
                  md += "### Функции\n\n"
                  for fn in functions:
                      args = ", ".join(fn["args"])
                      md += f"- **`{fn['name']}({args})`**  \n"
                      md += f"  {first_sentence(fn['doc'])}  \n"
                      md += f"  *строка {fn['line']}*\n\n"

              md += "---\n"
              md += "*Обновляется автоматически при коммите в main*\n"
              md += "<!-- AUTO-GENERATED DOCS END -->\n"

              with open(OUT_FILE, "w", encoding="utf-8") as f:
                  f.write(md)

              print("Документация сгенерирована")

          except Exception as e:
              print(f"Ошибка генерации документации: {e}")
              raise
          PY

      - name: Update README.md
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          python - <<'PY'
          import os

          DOCS_FILE = "AUTO_DOCS_TEMP.md"
          README_FILE = "README.md"
          START = "<!-- AUTO-GENERATED DOCS START -->"
          END = "<!-- AUTO-GENERATED DOCS END -->"

          if not os.path.exists(DOCS_FILE):
              print("Файл с документацией не найден, пропускаю обновление README.")
              raise SystemExit(0)

          with open(DOCS_FILE, "r", encoding="utf-8") as f:
              docs = f.read().rstrip() + "\n"

          if os.path.exists(README_FILE):
              with open(README_FILE, "r", encoding="utf-8") as f:
                  readme = f.read()
          else:
              readme = "# Мой проект\n\n"

          if START in readme and END in readme and readme.index(START) < readme.index(END):
              prefix = readme.split(START, 1)[0].rstrip() + "\n\n"
              suffix = readme.split(END, 1)[1].lstrip("\n")
              new_readme = prefix + docs + ("\n" + suffix if suffix else "")
          else:
              new_readme = readme.rstrip() + "\n\n" + docs

          with open(README_FILE, "w", encoding="utf-8") as f:
              f.write(new_readme.rstrip() + "\n")

          os.remove(DOCS_FILE)
          print("README.md обновлён")
          PY

      - name: Commit changes
        if: github.ref == 'refs/heads/main'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md

          if git diff --cached --quiet; then
            echo "Нет изменений для коммита"
            exit 0
          fi

          git commit -m "docs: auto-update [skip ci]"
          git push origin HEAD:${GITHUB_REF_NAME}
